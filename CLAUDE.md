# CLAUDE.md

本文件为 Claude Code (claude.ai/code) 在处理此仓库代码时提供指导。

## 项目概述

这是一个 API 统计仪表板系统，包含：
- **FastAPI 后端** (`api_stats_server_v2.py`)：集成 Redis 的实时 API 使用统计服务器
- **前端仪表板** (`index.html`)：用于查看 API 密钥统计和使用模式的交互式 Web 界面
- **模型定价数据库** (`model_pricing.json`)：各种 AI 模型（OpenAI、Claude 等）的综合定价数据

## 开发命令

### 运行服务器
```bash
# 测试环境
#!/Users/ruterfu/miniconda3/bin/python
# 测试用 redis（注意请勿执行任何写入操作，只允许读取。）
127.0.0.1:16379
# 启动 FastAPI 开发服务器（DEBUG 模式）
DEBUG=1 python api_stats_server_v2.py

# 启动生产服务器
python api_stats_server_v2.py
```
服务器运行在 `http://127.0.0.1:8001`

### 环境配置
- **DEBUG 模式**：使用位于 `127.0.0.1:16379` 的 Redis，为所有源启用 CORS
- **生产模式**：使用位于 `192.168.118.2:6379` 的 Redis，无 CORS
- 开发时设置 `DEBUG=1` 环境变量

## 架构

### 后端（FastAPI 服务器）
- **认证系统**：
  - API 密钥验证（需要 cr_ 前缀）
  - 在 `auth_token.json` 中持久化存储认证令牌，包含 IP 跟踪和用户代理信息
  - 基于令牌的会话管理，24 小时过期
- **数据源**：
  - 主要：包含使用统计的 Redis 数据库
  - 定价：用于成本计算的 `model_pricing.json`
- **关键端点**：
  - `POST /api/stats/all`：包含详细分解的主要统计端点
  - `GET /health`：Redis 连接性检查
- **IP 检测优先级**：`X-Real-IP` 头 > `X-Forwarded-For` > 客户端主机

### 前端（单页应用）
- **模态框系统**：
  - 带有用户特定过滤的每小时成本详情
  - 模型特定统计分解
  - 带有工具提示和进度条的响应式设计
- **认证流程**：
  - LocalStorage 令牌持久化
  - 页面加载时使用存储的令牌自动重试
- **数据显示**：
  - 实时 API 密钥统计
  - 会话窗口进度跟踪
  - 成本分解，4 位精度（显示）vs 6 位精度（详情）

### 数据处理
- **Redis 优化**：批量获取仅需要的键模式（`usage:*`、`apikey:*`、`claude:account:*`、`account_usage:*`）
- **成本计算**：使用定价数据库中的模型特定令牌成本进行实时定价
- **用户过滤**：模态框内容按特定 API 密钥所有者过滤
- **会话窗口**：Claude 账户会话跟踪，基于时间的成本计算

### 文件结构
- `api_stats_server_v2.py`：主 FastAPI 应用程序
- `index.html`：包含嵌入式 CSS/JS 的完整前端
- `model_pricing.json`：模型定价数据库（1000+ 个模型）
- `auth_token.json`：持久化认证存储
- `css/all.min.css` + `webfonts/`：Font Awesome 资源

## 关键实现细节

### 认证流程
1. 用户输入带 `cr_` 前缀的 API 密钥
2. 服务器对照 Redis 哈希映射验证
3. 生成 SHA1(MD5(api_key + salt)) 认证令牌
4. 将令牌与 IP、用户代理、时间戳存储在 JSON 文件中
5. 前端使用令牌进行后续请求

### 成本计算管道
1. 从 Redis 获取每小时使用数据
2. 应用来自 `model_pricing.json` 的模型特定定价
3. 分别计算输入/输出/缓存令牌成本
4. 按用户/时间段聚合以供显示
5. 支持 4 位（UI）和 6 位（详情）精度

### 模态框数据过滤
- 每小时统计：通过 userName 参数过滤 `detailed_stats`
- 模型统计：通过 userName 和 model 过滤 `model_detailed_stats`
- 时间格式：将 `HH:MM` 转换为 `HH:00 - HH:59` 范围
- 模型名称：去除 `claude-` 前缀，在等宽字体显示中填充对齐

### 窗口期进度条颜色系统
- **动态颜色变化**：窗口期可用费用和估算总费用进度条根据使用百分比显示不同颜色
- **颜色阶梯**：
  - `< 30%`: 绿色 (#2dce89) - `window-low`
  - `30-60%`: 黄色 (#ffc107) - `window-medium` 
  - `60-80%`: 橙色 (#fb6340) - `window-high`
  - `≥ 80%`: 红色 (#f5365c) - `window-critical`
- **应用范围**：
  - 周统计卡片：估算总费用进度条
  - 窗口统计卡片：窗口期可用费用进度条
  - 实现函数：`createWeeklyWindowCard()` 和 `displayAccounts()`

## 测试与调试

### 服务器健康检查
```bash
curl http://127.0.0.1:8001/health
```

### 认证测试
```bash
curl -X POST http://127.0.0.1:8001/api/stats/all \
  -H "Content-Type: application/json" \
  -d '{"api_key": "cr_your_test_key"}'
```

### 常见问题
- **Redis WRONGTYPE 错误**：服务器自动仅过滤到所需的键模式
- **模态框过滤**：确保 `userName` 参数与确切的 API 密钥名称匹配
- **精度显示**：UI 使用 `toFixed(4)`，详细分解使用 `toFixed(6)`
- **边框圆角**：最后一个表格行悬停状态需要特殊 CSS 处理以实现圆角
- **窗口进度条颜色**：使用 `.account-window-fill` 类配合 `window-low/medium/high/critical` 修饰符实现动态颜色变化

## 最近更新

### 2025-08-08: 模型标签Tooltip窗口统计增强
- **窗口统计显示**：在模型标签tooltip中添加窗口期统计信息
  - 仅在存在窗口时间且该模型有消耗时显示
  - 包含输入/输出、缓存创建/读取、总tokens、消费等完整信息
  - 标题显示具体时间范围，如"窗口统计（21:00 - 2:00）"
- **紧凑格式优化**：统一tooltip显示格式
  - 输入/输出合并为一行：`12.5K tokens / 15.5K tokens`
  - 缓存创建/读取合并为一行：`12.4M tokens / 123.3M tokens`
  - 窗口统计、今日统计、本月统计都使用相同格式
- **API Key列表排序**：按最后使用时间倒序排序，最近活跃的Key显示在顶部
- **Token统计计算**：使用基于费用比例的估算方法计算窗口期token使用量

### 2025-08-08: 窗口期进度条颜色优化
- 实现窗口期可用费用进度条的动态颜色系统
- 添加估算总费用进度条的相同颜色逻辑
- 定义4个颜色阶梯：绿色(< 30%) → 黄色(30-60%) → 橙色(60-80%) → 红色(≥ 80%)
- 去除渐变效果，使用固定纯色显示
- 更新CSS类：`.account-window-fill.window-{low,medium,high,critical}`

### 2025-08-08: 表格最后一行悬停圆角修复
- **问题**：表格最后一行在悬停时圆角效果短暂消失
- **原因**：`tr:hover` 背景色覆盖了圆角样式，需要在具体的 `td` 元素上设置圆角
- **解决方案**：为 `tbody tr:last-child:hover td` 的第一个和最后一个单元格添加专门的圆角样式
- **实现**：在 index.html:241-247 添加 `border-bottom-left-radius` 和 `border-bottom-right-radius` 样式

### 2025-08-08: 窗口消耗列和多分段进度条实现
- **功能替换**：将表格中"权限"列替换为"窗口消耗"列
- **窗口消耗显示**：
  - 有活跃窗口期时：显示金额和相对于所有用户总消耗的进度条
  - 无窗口期时：仅显示 $0.00，不显示进度条
  - 进度计算：当前用户窗口消耗 / 所有用户窗口消耗总和
- **多分段进度条系统**：
  - 窗口期可用费用和估算总费用使用多用户分段显示
  - 每个用户分段按消耗金额从多到少排序
  - 8种颜色区分不同用户（蓝、绿、橙、青、红、黄、紫、橘）
  - 鼠标悬停显示用户名和具体金额
- **CSS优化**：
  - 移除 `overflow: hidden` 避免tooltip被裁剪
  - 添加首尾分段圆角样式保持视觉效果
  - 统一tooltip样式与其他浮动框保持一致（#172b4d背景色）
- **数据计算优化**：
  - 周消耗改用 `detailed_stats` 实际数据计算，不再使用月消耗/4的估算
  - 确保分段进度条数据准确性

### 2025-08-08: 术语统一更新
- **界面文本优化**：
  - "今日费用" → "今日消耗"
  - "费用详情" → "消耗详情" 
  - "总费用" → "总消耗"
  - "估算总费用" → "估算总消耗"
  - "窗口期可用费用" → "窗口期消耗估算"
- **保持一致性**：所有相关提示、标签、模态框标题统一使用"消耗"术语